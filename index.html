<!doctype html>
<html lang="ru">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>FurBaza — каталог фурсьют-шопов</title>
<script src="https://cdn.tailwindcss.com"></script>
<style>

:root{--bg:#0b0c0f;--panel:#151820;--ring:rgba(255,255,255,.08);--text:#f6f7fb}
html,body{background:var(--bg);color:var(--text)}
.card{background:var(--panel);border:1px solid var(--ring);border-radius:18px;overflow:hidden;
      box-shadow:0 10px 24px rgba(0,0,0,.25);transform:translateY(8px);opacity:0;
      animation:cardIn .5s ease both;}
@keyframes cardIn{to{transform:translateY(0);opacity:1}}
.card:hover{transform:translateY(-3px) scale(1.01);transition:.25s ease}
.btn{border-radius:12px;padding:.5rem 1rem;font-weight:700;background:#1f6feb;box-shadow:0 6px 20px rgba(31,111,235,.25)}
.btn:hover{transform:translateY(-2px);filter:brightness(1.05)}
.btn-secondary{border-radius:12px;padding:.5rem 1rem;background:#222630;border:1px solid var(--ring)}
.control{background:#0f131a;border:1px solid var(--ring);border-radius:14px;padding:.65rem 1rem}
.star{width:20px;height:20px;display:inline-block;mask:url('data:image/svg+xml;utf8,<svg xmlns="http://www.w3.org/2000/svg" viewBox=\'0 0 24 24\'><path fill=\'#fff\' d=\'M12 17.27 18.18 21l-1.64-7.03L22 9.24l-7.19-.61L12 2 9.19 8.63 2 9.24l5.46 4.73L5.82 21z\'/></svg>') no-repeat center / contain;background:#3b82f6;margin-right:2px;transition:transform .2s}
.star.pulse{animation: twinkle 900ms ease}
@keyframes twinkle{50%{transform:scale(1.2) rotate(-3deg)}}
.price{color:#34d399;font-weight:800}

</style>
</head>
<body class="min-h-screen">
<header class="max-w-6xl mx-auto px-4 py-6">
  <h1 class="text-2xl md:text-3xl font-extrabold mb-4">FurBaza</h1>

  <!-- Поиск + сортировка цены справа как на скрине -->
  <div class="flex items-center gap-3">
    <input id="search" class="control flex-1" placeholder="Введите имя или город...">
    <div class="relative">
      <button id="priceBtn" class="btn-secondary flex items-center gap-2">
        <span id="priceLabel">Цена: по убыванию</span>
        <svg width="18" height="18" viewBox="0 0 24 24"><path fill="currentColor" d="m7 10l5 5l5-5z"/></svg>
      </button>
      <div id="priceMenu" class="hidden absolute right-0 mt-2 w-56 rounded-xl overflow-hidden border border-slate-700 bg-[#0f131a]">
        <button data-sort="desc" class="block w-full text-left px-4 py-3 hover:bg-slate-800">Цена: по убыванию</button>
        <button data-sort="asc"  class="block w-full text-left px-4 py-3 hover:bg-slate-800">Цена: по возрастанию</button>
      </div>
    </div>
  </div>

  <!-- Фильтры "Топ" / "Все" вместо старой сортировки -->
  <div class="mt-4 flex gap-2">
    <button id="filterTop" class="btn">Топ</button>
    <button id="filterAll" class="btn-secondary">Все</button>
  </div>
</header>

<main class="max-w-6xl mx-auto px-4 pb-16">
  <div id="grid" class="grid gap-5 sm:grid-cols-2 lg:grid-cols-3"></div>
</main>

<script>

function renderStars(el, value){
  const max=5;
  const whole=Math.floor(value);
  const frac=value - whole;
  el.innerHTML='';
  for(let i=0;i<max;i++){
    const s=document.createElement('span');
    s.className='star';
    if(i<whole){ s.style.opacity=1; }
    else if(i===whole && frac>0){ s.style.background='linear-gradient(90deg,#3b82f6 '+(frac*100)+'%, rgba(255,255,255,.15) '+(frac*100)+'%)'; }
    else{ s.style.background='rgba(255,255,255,.15)'; }
    el.appendChild(s);
  }
}


// загрузка
async function loadList(){
  const res = await fetch('shops/list.json', {cache:'no-store'});
  return await res.json();
}

function money(n){ return new Intl.NumberFormat('ru-RU').format(n) + ' ₽'; }
function getSavedRating(name, fallback){
  const map = JSON.parse(localStorage.getItem('ratings')||'{}');
  return map[name] ?? fallback ?? 0;
}
function saveRating(name, value){
  const map = JSON.parse(localStorage.getItem('ratings')||'{}');
  map[name] = value;
  localStorage.setItem('ratings', JSON.stringify(map));
}

function makeCard(shop){
  const wrap = document.createElement('article');
  wrap.className='card flex flex-col';

  wrap.innerHTML = `
    <img src="${shop.image}" alt="${shop.name}" class="w-full h-48 object-cover">
    <div class="p-4 flex-1 flex flex-col gap-2">
      <div class="text-lg font-bold">${shop.name}</div>
      <div class="text-sm opacity-80">${shop.city}</div>
      <div class="text-sm opacity-90">${shop.description}</div>
      <div class="price text-lg mt-1">от ${money(shop.price)}</div>

      <div class="mt-2">
        <div class="flex items-center gap-2">
          <div class="stars flex" aria-label="Рейтинг" title="Рейтинг"></div>
          <span class="text-sm opacity-80 ratingValue"></span>
        </div>
        <div class="mt-2 flex items-center gap-2">
          <input type="number" min="0" max="5" step="0.1" class="control w-24 ratingInput" placeholder="0–5">
          <button class="btn-secondary px-3 py-2 setRating">Поставить</button>
        </div>
      </div>

      <div class="mt-auto pt-2">
        <a href="${shop.url}" class="btn w-full text-center">Открыть</a>
      </div>
    </div>
  `;

  // Рейтинг
  const starsEl = wrap.querySelector('.stars');
  const valueEl = wrap.querySelector('.ratingValue');
  const inputEl = wrap.querySelector('.ratingInput');
  const btnEl = wrap.querySelector('.setRating');

  let current = parseFloat(getSavedRating(shop.name, shop.rating||0)) || 0;
  function draw(){
    renderStars(starsEl, current);
    valueEl.textContent = current.toFixed(1);
  }
  draw();

  btnEl.addEventListener('click', ()=>{
    const v = Math.max(0, Math.min(5, parseFloat(inputEl.value)));
    if(!isNaN(v)){
      current = v;
      saveRating(shop.name, v);
      draw();
      starsEl.querySelectorAll('.star').forEach(s=>s.classList.add('pulse'));
      setTimeout(()=>starsEl.querySelectorAll('.star').forEach(s=>s.classList.remove('pulse')), 900);
    }
  });

  return wrap;
}

function render(list){
  const grid = document.getElementById('grid');
  grid.innerHTML='';
  list.forEach(s=> grid.appendChild(makeCard(s)));
}

(async function(){
  const search = document.getElementById('search');
  const priceBtn = document.getElementById('priceBtn');
  const priceMenu = document.getElementById('priceMenu');
  const priceLabel = document.getElementById('priceLabel');
  const topBtn = document.getElementById('filterTop');
  const allBtn = document.getElementById('filterAll');

  let all = await loadList();
  let onlyTop = false;
  let priceSort = 'desc'; // desc|asc

  function apply(){
    let filtered = all.filter(s => !onlyTop || s.top);
    const q = search.value.trim().toLowerCase();
    if(q) filtered = filtered.filter(s => (s.name+' '+s.city).toLowerCase().includes(q));
    filtered.sort((a,b)=> priceSort==='desc' ? (b.price - a.price) : (a.price - b.price));
    render(filtered);
  }

  // Поиск
  search.addEventListener('input', apply);

  // Кнопки топ/все
  topBtn.addEventListener('click', ()=>{ onlyTop = true; topBtn.classList.add('btn'); topBtn.classList.remove('btn-secondary'); allBtn.classList.add('btn-secondary'); allBtn.classList.remove('btn'); apply(); });
  allBtn.addEventListener('click', ()=>{ onlyTop = false; allBtn.classList.add('btn'); allBtn.classList.remove('btn-secondary'); topBtn.classList.add('btn-secondary'); topBtn.classList.remove('btn'); apply(); });

  // Выпадайка цены (как на скрине — справа от поиска)
  priceBtn.addEventListener('click', ()=> priceMenu.classList.toggle('hidden'));
  priceMenu.querySelectorAll('button').forEach(b=> b.addEventListener('click', ()=>{
    priceSort = b.dataset.sort;
    priceLabel.textContent = b.textContent;
    priceMenu.classList.add('hidden');
    apply();
  }));

  apply();
})();
</script>
</body>
</html>
